{% extends "layouts/base.html" %}

{% block title %}{{ bucket_name }} - Jax{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto space-y-6">
    <!-- Historical version banner -->
    {% include "components/historical_banner.html" %}

    <!-- Breadcrumb navigation -->
    <nav aria-label="Breadcrumb">
        <ol class="flex items-center gap-2 text-sm">
            <li><a href="/buckets" class="text-primary hover:underline">Buckets</a></li>
            <li><i class="fas fa-chevron-right text-muted-foreground"></i></li>
            <li><a href="/buckets/{{ bucket_id }}{% if viewing_history %}?at={{ bucket_link }}{% endif %}" class="text-primary hover:underline">{{ bucket_name }}</a></li>
            {% for segment in path_segments %}
            <li><i class="fas fa-chevron-right text-muted-foreground"></i></li>
            <li><a href="/buckets/{{ bucket_id }}?path={{ segment.path }}{% if viewing_history %}&at={{ bucket_link }}{% endif %}" class="text-primary hover:underline">{{ segment.name }}</a></li>
            {% endfor %}
        </ol>
    </nav>

    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold">
                <i class="fas fa-folder-open mr-2"></i>{{ bucket_name }}
            </h1>
            <div class="mt-2 space-y-1">
                <div class="flex items-center gap-2">
                    <code class="inline-block text-xs bg-muted px-2 py-1 rounded font-mono cursor-pointer hover:bg-gray-200"
                          onclick="navigator.clipboard.writeText('{{ bucket_link }}')"
                          title="{{ bucket_link }} (click to copy)">
                        Bucket: {{ bucket_link_short }}
                    </code>
                    <button uk-toggle="target: #bucket-data-modal" class="text-xs text-primary hover:underline">
                        <i class="fas fa-info-circle"></i> Details
                    </button>
                </div>
                {% if previous_link.is_some() %}
                <div>
                    <code class="inline-block text-xs bg-muted px-2 py-1 rounded font-mono cursor-pointer hover:bg-gray-200"
                          onclick="navigator.clipboard.writeText('{{ previous_link_full }}')"
                          title="{{ previous_link_full }} (click to copy)">
                        Previous: {{ previous_link_short }}
                    </code>
                </div>
                {% endif %}
            </div>
        </div>
        <div class="flex gap-2">
            {% if !read_only %}
            <button uk-toggle="target: #new-file-modal" class="button button-primary">
                <i class="fas fa-file-plus"></i> New File
            </button>
            <button uk-toggle="target: #upload-modal" class="button">
                <i class="fas fa-upload"></i> Upload
            </button>
            {% endif %}
            <a href="/buckets/{{ bucket_id }}/logs" class="button">
                <i class="fas fa-history"></i> History
            </a>
            <a href="/buckets/{{ bucket_id }}/pins" class="button">
                <i class="fas fa-thumbtack"></i> Pins
            </a>
            <a href="/buckets/{{ bucket_id }}/peers" class="button">
                <i class="fas fa-users"></i> Peers
            </a>
            {% if !read_only %}
            <button uk-toggle="target: #share-modal" class="button">
                <i class="fas fa-share-alt"></i> Share
            </button>
            {% endif %}
            {% if current_path != "/" %}
            <a href="{{ parent_path_url }}" class="button">
                <i class="fas fa-arrow-up"></i> Up
            </a>
            {% endif %}
        </div>
    </div>

    <!-- New File Modal -->
    {% if !read_only %}
    <div id="new-file-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Create New File</h2>
            <form id="newFileForm" class="space-y-4">
                <div>
                    <label for="newFileName" class="block text-sm font-medium mb-2">File Name</label>
                    <input type="text" id="newFileName" name="filename" class="uk-input"
                           placeholder="example.txt or example.md" required>
                    <p class="text-xs text-muted-foreground mt-1">Supported: .txt and .md files</p>
                </div>
                <div>
                    <label for="newFileContent" class="block text-sm font-medium mb-2">Initial Content (Optional)</label>
                    <textarea id="newFileContent" name="content" class="uk-input" rows="6"
                              placeholder="Start typing or leave empty..."></textarea>
                </div>
                <div id="newFileStatus" class="hidden"></div>
                <div class="flex gap-4 justify-end mt-4">
                    <button class="button button-danger uk-modal-close" type="button">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="button button-primary">
                        <i class="fas fa-check"></i> Create & Edit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Upload File</h2>
            <form id="uploadForm" class="space-y-4">
                <div>
                    <label for="fileInput" class="block text-sm font-medium mb-2">Select File</label>
                    <input type="file" id="fileInput" name="file" class="uk-input" required>
                </div>
                <div>
                    <label for="pathInput" class="block text-sm font-medium mb-2">Destination Directory</label>
                    <input type="text" id="pathInput" name="path" class="uk-input" value="{{ current_path }}">
                    <p class="text-xs text-muted-foreground mt-1">File will be uploaded to this directory</p>
                </div>
                <div id="uploadStatus" class="hidden"></div>
                <div class="flex gap-4 justify-end mt-4">
                    <button class="button button-danger uk-modal-close" type="button">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="button button-primary">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Share Modal -->
    <div id="share-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Share Bucket</h2>
            <form id="shareForm" class="space-y-4">
                <div>
                    <label for="peerPublicKeyInput" class="block text-sm font-medium mb-2">Peer Public Key</label>
                    <input
                        type="text"
                        id="peerPublicKeyInput"
                        name="peer_public_key"
                        class="uk-input"
                        placeholder="Enter peer's public key (hex)"
                        required
                        pattern="[a-fA-F0-9]{64}"
                        title="Public key must be a 64-character hexadecimal string"
                    >
                    <p class="text-xs text-muted-foreground mt-1">
                        The peer's public key in hexadecimal format (64 characters)
                    </p>
                </div>
                <div id="shareStatus" class="hidden"></div>
                <div class="flex gap-4 justify-end mt-4">
                    <button class="button button-danger uk-modal-close" type="button">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="button button-primary">
                        <i class="fas fa-share-alt"></i> Share
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Rename Modal -->
    <div id="rename-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Rename <span id="renameItemType"></span></h2>
            <form id="renameForm" class="space-y-4">
                <input type="hidden" id="renameOldPath" name="old_path">
                <div>
                    <label for="renameNewName" class="block text-sm font-medium mb-2">New Name</label>
                    <input type="text" id="renameNewName" name="new_name" class="uk-input" required>
                </div>
                <div id="renameStatus" class="hidden"></div>
                <div class="flex gap-4 justify-end mt-4">
                    <button class="button button-danger uk-modal-close" type="button">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="button button-primary">
                        <i class="fas fa-check"></i> Rename
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body">
            <h2 class="uk-modal-title">Delete <span id="deleteItemType"></span></h2>
            <p>Are you sure you want to delete <strong id="deleteItemName"></strong>?</p>
            <p class="text-sm text-muted-foreground">This action cannot be undone.</p>
            <input type="hidden" id="deleteItemPath">
            <div id="deleteStatus" class="hidden"></div>
            <div class="flex gap-4 justify-end mt-4">
                <button class="button uk-modal-close" type="button">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button onclick="confirmDelete()" class="button button-danger">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Bucket Data Modal -->
    <div id="bucket-data-modal" uk-modal>
        <div class="uk-modal-dialog uk-modal-body" style="max-width: 800px;">
            <button class="uk-modal-close-default" type="button" uk-close></button>
            <h2 class="uk-modal-title">Bucket Data</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-sm font-semibold mb-2">Formatted Bucket Data:</h3>
                    <pre class="bg-muted p-4 rounded text-xs overflow-auto max-h-96 font-mono">{{ bucket_data_formatted }}</pre>
                    <button onclick="navigator.clipboard.writeText(document.querySelector('#bucket-data-modal pre').textContent)"
                            class="button button-sm mt-2">
                        <i class="fas fa-copy"></i> Copy to Clipboard
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% if items.is_empty() %}
    <div class="card">
        <div class="p-8 text-center text-muted-foreground">
            <i class="fas fa-folder-open text-4xl mb-4"></i>
            <p>This bucket is empty</p>
            <p class="text-sm">Add files using the CLI to get started</p>
        </div>
    </div>
    {% else %}
    <div class="card">
        <table class="uk-table uk-table-divider uk-table-hover">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Type</th>
                    <th>MIME Type</th>
                    <th>Link</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>
                        {% if item.is_dir %}
                        <a href="/buckets/{{ bucket_id }}?path={{ item.path }}" class="text-primary font-semibold hover:underline">
                            <i class="fas fa-folder text-yellow-500 mr-2"></i>{{ item.name }}
                        </a>
                        {% else %}
                        <span class="font-semibold">
                            <i class="fas fa-file text-blue-500 mr-2"></i>{{ item.name }}
                        </span>
                        {% endif %}
                    </td>
                    <td class="text-sm text-muted-foreground">
                        {% if item.is_dir %}
                        <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded">Directory</span>
                        {% else %}
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded">File</span>
                        {% endif %}
                    </td>
                    <td class="text-xs text-muted-foreground">{{ item.mime_type }}</td>
                    <td><code class="text-xs text-muted-foreground">{{ item.link }}</code></td>
                    <td>
                        <div class="flex gap-2 flex-wrap">
                            {% if item.is_dir %}
                            <a href="/buckets/{{ bucket_id }}?path={{ item.path }}{% if viewing_history %}&at={{ bucket_link }}{% endif %}" class="button button-sm">
                                <i class="fas fa-folder-open"></i> Open
                            </a>
                            {% else %}
                            <a href="/buckets/{{ bucket_id }}/view?path={{ item.path }}{% if viewing_history %}&at={{ bucket_link }}{% endif %}" class="button button-sm button-primary">
                                <i class="fas fa-eye"></i> View
                            </a>
                            {% endif %}
                            {% if !read_only %}
                            <button onclick="openRenameModal('{{ item.path }}', '{{ item.name }}', {{ item.is_dir }})" class="button button-sm">
                                <i class="fas fa-i-cursor"></i> Rename
                            </button>
                            <button onclick="openDeleteModal('{{ item.path }}', '{{ item.name }}', {{ item.is_dir }})" class="button button-sm button-danger">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block head %}
<script>
window.JAX_API_URL = '{{ api_url }}';
window.JAX_BUCKET_ID = '{{ bucket_id }}';
window.JAX_CURRENT_PATH = '{{ current_path }}';
</script>
{% endblock %}
