name: Release Desktop App

on:
  push:
    tags:
      - "jax-desktop-v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g. 0.1.0)"
        required: true

permissions:
  contents: write

jobs:
  build:
    name: Build macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install macFUSE
        run: brew install --cask macfuse

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          cache-dependency-path: crates/desktop/pnpm-lock.yaml

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-tauri-release-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-tauri-release-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-tauri-release-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-tauri-release-build-

      - name: Install frontend dependencies
        working-directory: crates/desktop
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          projectPath: crates/desktop
          tauriScript: pnpm tauri

      - name: Build CLI binary
        run: cargo build --release -p jax-daemon --bin jax

      - name: Package CLI binary
        run: tar -czf jax-cli-macos-aarch64.tar.gz -C target/release jax

      - name: Find and list DMG files
        id: find-dmg
        run: |
          echo "Looking for DMG files..."
          find crates/desktop/src-tauri/target -name "*.dmg" -type f 2>/dev/null || true
          DMG_PATH=$(find crates/desktop/src-tauri/target -name "*.dmg" -type f 2>/dev/null | head -1)
          if [ -n "$DMG_PATH" ]; then
            echo "Found DMG: $DMG_PATH"
            echo "dmg_path=$DMG_PATH" >> $GITHUB_OUTPUT
          else
            echo "No DMG found!"
            exit 1
          fi

      - name: Upload desktop artifact
        uses: actions/upload-artifact@v4
        with:
          name: jax-desktop-macos
          path: crates/desktop/src-tauri/target/release/bundle/dmg/*.dmg
          if-no-files-found: error

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: jax-cli-macos
          path: jax-cli-macos-aarch64.tar.gz
          if-no-files-found: error

  build-cli-linux:
    name: Build CLI Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse3-dev pkg-config

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cli-release-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cli-release-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cli-release-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cli-release-build-

      - name: Build CLI binary
        run: cargo build --release -p jax-daemon --bin jax

      - name: Package CLI binary
        run: tar -czf jax-cli-linux-x86_64.tar.gz -C target/release jax

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: jax-cli-linux
          path: jax-cli-linux-x86_64.tar.gz
          if-no-files-found: error

  build-cli-windows:
    name: Build CLI Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cli-release-registry-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cli-release-registry-

      - name: Cache cargo build
        uses: actions/cache@v4
        with:
          path: target
          key: ${{ runner.os }}-cli-release-build-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cli-release-build-

      - name: Build CLI binary
        run: cargo build --release -p jax-daemon --bin jax

      - name: Package CLI binary
        shell: pwsh
        run: Compress-Archive -Path target\release\jax.exe -DestinationPath jax-cli-windows-x86_64.zip

      - name: Upload CLI artifact
        uses: actions/upload-artifact@v4
        with:
          name: jax-cli-windows
          path: jax-cli-windows-x86_64.zip
          if-no-files-found: error

  release:
    name: Create Release
    needs: [build, build-cli-linux, build-cli-windows]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            echo "tag=jax-desktop-v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            TAG="${GITHUB_REF#refs/tags/}"
            VERSION="${TAG#jax-desktop-v}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi

      - name: List artifacts
        run: find artifacts -type f | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Jax Desktop v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.tar.gz
            artifacts/**/*.zip
          body: |
            ## Jax Desktop v${{ steps.version.outputs.version }}

            ### Desktop App
            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | `.dmg` |

            ### CLI Binary
            | Platform | File |
            |----------|------|
            | macOS (Apple Silicon) | `jax-cli-macos-aarch64.tar.gz` |
            | Linux (x86_64) | `jax-cli-linux-x86_64.tar.gz` |
            | Windows (x86_64) | `jax-cli-windows-x86_64.zip` |

            ### Installation

            **Desktop App:**
            1. Download the `.dmg` file
            2. Open it and drag Jax to Applications
            3. **Requires [macFUSE](https://osxfuse.github.io/)** for FUSE mount support

            **CLI Only:**
            1. Download the archive for your platform
            2. Extract: `tar -xzf jax-cli-*.tar.gz` (or unzip on Windows)
            3. Move `jax` to a directory in your PATH
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
